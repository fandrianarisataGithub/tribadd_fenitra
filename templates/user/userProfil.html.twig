{% extends 'layout.html.twig' %}
{% block stylesheets %}
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/css/toastr.min.css" integrity="sha512-vKMx8UnXk60zUwyUnUPM3HbQo8QfmNx7+ltw8Pm5zLusl1XIfwcxo8DbWCqMGKaWeNxWA8yrx5v3SaVpMvR3CA==" crossorigin="anonymous" />
{% endblock %}
{% block body %}
<div class="main">
    <div class="profile-container">
        <div class="row mb-5 p-4">
            <div class="col-md-4">
                <form onsubmit="changeProfile(event)" action="{{ path('myProfile') }}" method="post" enctype="multipart/form-data" class="d-flex flex-column justify-content-center align-items-center">
                    <div id="container-img">
                        <div class="water loader-md"></div>
                        <img onclick="$('#fileProfile').click()" style="cursor: pointer" class="shadow-sm rounded d-none" src="{{ app.user.photo is null ? asset('assets/image/default.jpg') : asset('photo_de_profil/' ~ app.user.photo) }}" alt="photo par defaut">
                    </div>
                    <span class="d-inline-block my-3">Séléctionnez votre photo de profil</span>
                    <input type="file" name="photoProfil" class="custom-file-input d-none" id="fileProfile" lang="fr" accept="image/*">
                    <span id="profileHelp" class="form-text text-muted error-register d-none">Vous devez d'abord choisir une nouvelle photo pour pouvoir changer de profil</span>
                    <div class="form-group">
                        <input type="submit" value="changer" class="btn btn-sm btn btn-yellow">
                    </div>
                </form><br>
                <div class="card">
                    <div class="card-header">Site web <i class="fa fa-link fa-1x"></i></div>
                    <div class="card-body">{% if app.user.siteWeb is not null %}<a href="{{ app.user.siteWeb }}">{{ app.user.siteWeb }}</a>{% else %}non renseigné{% endif %}</div>
                </div>
                <br>
                <ul class="list-group">
                    <li class="list-group-item text-muted">Activité <i class="fa fa-dashboard fa-1x"></i></li>
                    <li class="list-group-item text-md-right"><span class="float-md-left"><strong>Tribu fondée</strong></span> {{ app.user.communautes|length }}</li>
                    <li class="list-group-item text-md-right"><span class="float-md-left"><strong>Tribu membre</strong></span> {{ app.user.membres|length }}</li>
                    <li class="list-group-item text-md-right"><span class="float-md-left"><strong>Posts</strong></span> {{ app.user.posts|length }}</li>
                </ul>

            </div><!--/col-3-->
            <div class="col-md-8 mt-sm-3 d-flex flex-column">
                <button class="btn btn-blue ml-auto" id="update"><i class="fas fa-pen"></i> Modifier</button>
                <button class="btn btn-blue ml-auto d-none" id="back"><i class="fas fa-arrow-left"></i> Afficher</button>
                <hr>
                {{ form_start(form, {'attr': {'class': 'd-none', 'id': 'form-profile'}}) }}
                <div class="form-row">
                    <div class="form-group col-md-6">
                        <label for="email">Email</label>
                        <input type="text" disabled class="form-control" id="email" placeholder="Email" value="{{ app.user.email }}">
                    </div>
                    <div class="form-group col-md-6">
                        <label for="username">Pseudo</label>
                        <input type="text" disabled class="form-control" id="username" placeholder="Pseudo" value="{{ app.user.username }}">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group col-md-6">
                        {{ form_label(form.nom) }}
                        {{ form_widget(form.nom) }}
                        <span id="nameHelp" class="form-text text-muted error-register">{{ form_errors(form.nom) }}</span>
                    </div>
                    <div class="form-group col-md-6">
                        {{ form_label(form.prenom) }}
                        {{ form_widget(form.prenom) }}
                        <span id="firstNameHelp" class="form-text text-muted error-register">{{ form_errors(form.prenom) }}</span>
                    </div>
                </div>
                <div class="form-group">
                    {{ form_label(form.dateNaissance) }}
                    {{ form_widget(form.dateNaissance) }}
                    <span id="birthdayHelp" class="form-text text-muted error-register">{{ form_errors(form.dateNaissance) }}</span>
                </div>
                <div class="form-group">
                    {{ form_label(form.adresse) }}
                    {{ form_widget(form.adresse) }}
                    <span id="addressHelp" class="form-text text-muted error-register">{{ form_errors(form.adresse) }}</span>
                </div>
                <div class="form-group">
                    {{ form_label(form.telephone) }}
                    {{ form_widget(form.telephone) }}
                    <span id="phoneHelp" class="form-text text-muted error-register">{{ form_errors(form.telephone) }}</span>
                </div>
                <div class="form-group">
                    {{ form_label(form.siteWeb) }}
                    {{ form_widget(form.siteWeb) }}
                    <span id="websiteHelp" class="form-text text-muted error-register">{{ form_errors(form.siteWeb) }}</span>
                </div>
                <div class="form-group">
                    {{ form_label(form.description) }}
                    {{ form_widget(form.description, {'attr': {'rows': '4'}}) }}
                    <span id="descriptionHelp" class="form-text text-muted error-register">{{ form_errors(form.description) }}</span>
                </div>
                <div class="form-row">
                    <div class="col-md-12">
                        <button class="btn btn-yellow" disabled type="submit"><i class="fas fa-check"></i> Sauvegarder</button>
                        <button class="btn btn-outline-secondary" type="reset"><i class="fa fa-redo"></i> Réinitialiser</button>
                    </div>
                </div>
                {{ form_rest(form) }}
                {{ form_end(form) }}
                <div class="col-md-12" id="profile">
                    <div class="row">
                        <div class="col-md-6">
                            <label>Email</label>
                        </div>
                        <div class="col-md-6">
                            <p class="font-weight-bold">{{ app.user.email }}</p>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <label>Pseudo</label>
                        </div>
                        <div class="col-md-6">
                            <p class="font-weight-bold">{{ app.user.username }}</p>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <label>Nom</label>
                        </div>
                        <div class="col-md-6">
                            <p>{{ app.user.nom is null ? '<span class="text-danger">non renseigné</span>' : app.user.nom }}</p>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <label>Prénom</label>
                        </div>
                        <div class="col-md-6">
                            <p>{{ app.user.prenom is null ? '<span class="text-danger">non renseigné</span>' : app.user.prenom }}</p>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <label>Date de naissance</label>
                        </div>
                        <div class="col-md-6">
                            <p>{{ app.user.dateNaissance is null ? '<span class="text-danger">non reseignée</span>' : app.user.dateNaissance|date('d-m-y') }}</p>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <label>Adresse</label>
                        </div>
                        <div class="col-md-6">
                            <p>{{ app.user.adresse is null ? '<span class="text-danger">non renseigné</span>' : app.user.adresse }}</p>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <label>Numéro mobile</label>
                        </div>
                        <div class="col-md-6">
                            <p>{{ app.user.telephone is null ? '<span class="text-danger">non renseigné</span>' : app.user.telephone }}</p>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <label>Site web</label>
                        </div>
                        <div class="col-md-6">
                            <p>{{ app.user.siteWeb is null ? '<span class="text-danger">non renseigné</span>' : app.user.siteWeb }}</p>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <label>Description</label>
                        </div>
                        <div class="col-md-6">
                            <p>{{ app.user.description is null ? '<span class="text-danger">non renseignée</span>' : app.user.description }}</p>
                        </div>
                    </div>
                </div>
                <hr>
            </div><!--/tab-content-->
        </div>
    </div>
</div>
{% endblock %}
{% block javascripts %}
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/js/toastr.min.js" integrity="sha512-VEd+nq25CkR676O+pLBnDW09R7VQX9Mdiij052gVCp5yVH3jGtH70Ho/UUv4mJDsEdTvqRCFZg0NKGiojGnUCw==" crossorigin="anonymous"></script>
    <script>
        (function () {
            const canvas = $('canvas')[0];
            const ctx = canvas.getContext('2d');
            let img;
            const container = document.getElementById('container-img')
            const origin = container.querySelector('img')

            $('#container-img')
                .on('dragover', function(e) {
                    e.preventDefault();
                    return false;
                })
                .on('drop', function(e) {
                    var files = e.originalEvent.dataTransfer.files;
                    handleFiles(files);
                    return false;
                });

            $('#fileProfile').change(function() {
                handleFiles(this.files);
            });

            function handleFiles(files) {
                if (files.length > 0) {
                    var file = files[0];
                    if (
                        typeof FileReader !== 'undefined' &&
                        file.type.indexOf('image') != -1
                    ) {
                        var reader = new FileReader();
                        // Note: addEventListener doesn't work in Google Chrome for this event
                        reader.onload = function(evt) {
                            load(evt.target.result);
                        };
                        reader.readAsDataURL(file);
                    }
                } else {
                    load("{{ app.user.photo is null ? asset('assets/image/default.jpg') : asset('photo_de_profil/' ~ app.user.photo) }}")
                }
            }

            load(origin.src)

            function load(src) {
                $(origin).addClass('d-none')
                $(container).find('div.water').removeClass('d-none')
                img = new Image();
                img.onload = function() {
                    run();
                };
                img.src = src;
            }

            function run() {
                if (!img) return;
                var options = {
                    width: container.offsetWidth,
                    height: container.offsetHeight,
                    minScale: 1,
                    ruleOfThirds: true,
                    debug: true
                };
                var analyzeOptions = analyze.bind(this, options);
                analyzeOptions();
            }
            function analyze(options) {
                smartcrop.crop(img, options, draw);
            }

            function draw(result) {
                var selectedCrop = result.topCrop;
                drawCrop(selectedCrop);
            }

            function drawCrop(crop) {
                canvas.width = container.offsetWidth;
                canvas.height = container.offsetHeight;
                ctx.drawImage(
                    img,
                    crop.x,
                    crop.y,
                    crop.width,
                    crop.height,
                    0,
                    0,
                    canvas.width,
                    canvas.height
                );
                $(origin).attr('src', canvas.toDataURL(img.type))
                $(origin).removeClass('d-none')
                $(container).find('div.water').addClass('d-none')
            }
        })()
        {% for message in app.session.flashbag.get('success') %}
        // Sample Toastr Notification
        setTimeout(function()
        {
            const opts = {
                "closeButton": true,
                "debug": false,
                "newestOnTop": false,
                "progressBar": true,
                "positionClass": "toast-top-right",
                "preventDuplicates": true,
                "onclick": null,
                "showDuration": "300",
                "hideDuration": "1000",
                "timeOut": "10000",
                "extendedTimeOut": "1000",
                "showEasing": "swing",
                "hideEasing": "linear",
                "showMethod": "fadeIn",
                "hideMethod": "fadeOut"
            };
            toastr.success("{{ message }}", '', opts);
        },500);
        {% endfor %}
        {% for message in app.session.flashbag.get('info') %}
        // Sample Toastr Notification
        setTimeout(function()
        {
            const opts = {
                "closeButton": true,
                "debug": false,
                "newestOnTop": false,
                "progressBar": true,
                "positionClass": "toast-top-right",
                "preventDuplicates": true,
                "onclick": null,
                "showDuration": "300",
                "hideDuration": "1000",
                "timeOut": "10000",
                "extendedTimeOut": "1000",
                "showEasing": "swing",
                "hideEasing": "linear",
                "showMethod": "fadeIn",
                "hideMethod": "fadeOut"
            };
            toastr.info("{{ message }}", '', opts);
        },500);
        {% endfor %}
        const $form = $('#form-profile'),
            origForm = $form.serialize();
        function fileEmpty() {
            $('#fileProfile').on('change', function () {
                if (!document.getElementById('fileProfile').files.length) {
                    $('#profileHelp').removeClass('d-none')
                } else {
                    $('#profileHelp').addClass('d-none')
                }
            })
        }
        function changeProfile(e) {
            if (!document.getElementById('fileProfile').files.length) {
                e.preventDefault()
                $('#profileHelp').removeClass('d-none')
                fileEmpty()
                return false
            }
        }

        $('#form-profile :input').on('change input', function() {
            if ($form.serialize() !== origForm)
                $('#form-profile').find('[type="submit"]').prop('disabled', false)
            else
                $('#form-profile').find('[type="submit"]').prop('disabled', true)
        });
        $("#form-profile [type='reset']").on("click", function(e) {
            e.preventDefault()
            $("#form-profile").get(0).reset()
            if ($form.serialize() !== origForm)
                $('#form-profile').find('[type="submit"]').prop('disabled', false)
            else
                $('#form-profile').find('[type="submit"]').prop('disabled', true)
        });
        $('#update').on('click', function (e) {
            e.preventDefault()
            $(this).addClass('d-none')
            $('#back').removeClass('d-none')
            $('#form-profile').removeClass('d-none')
            $('#profile').addClass('d-none')
        })
        $('#back').on('click', function (e) {
            e.preventDefault()
            $(this).addClass('d-none')
            $('#update').removeClass('d-none')
            $('#form-profile').addClass('d-none')
            $('#profile').removeClass('d-none')
        })
        $(".custom-file-input").on("change", function(e) {
            if (e.target.files.length == 0) {
                $(this).siblings(".custom-file-label").removeClass("selected").html($(this).siblings(".custom-file-label").data('reset-label'));
                return
            }

            const fileName = $(this).val().split("\\").pop();
            $(this).siblings(".custom-file-label").addClass("selected").html(fileName);
        });
    </script>
{% endblock %}