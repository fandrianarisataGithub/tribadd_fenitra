{% extends 'layout2.html.twig' %}
{% block stylesheets %}
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/css/toastr.min.css" integrity="sha512-vKMx8UnXk60zUwyUnUPM3HbQo8QfmNx7+ltw8Pm5zLusl1XIfwcxo8DbWCqMGKaWeNxWA8yrx5v3SaVpMvR3CA==" crossorigin="anonymous" />
    <style>
        body {
            font-family: "lato", sans-serif;
        }
        h2 small {
            font-size: 0.5em;
        }

        .responsive-table li {
            border-radius: 3px;
            padding: 5px 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        .responsive-table .table-header {
            background-color: rgba(13, 105, 180, .4);
            text-transform: uppercase;
            letter-spacing: 0.03em;
        }
        .responsive-table .table-header div:not(.responsive-table .table-header div:first-child), .responsive-table .table-row div:not(.responsive-table .table-row div:first-child) {
            text-align: center;
        }
        .responsive-table .table-row {
            background-color: #ffffff;
            box-shadow: 0 0 9px 0 rgba(0, 0, 0, 0.1);
        }
        .responsive-table .col-4 {
            flex-basis: 25%;
        }
        .btn.btn-icon.btn-sm {
            width: 2.5em;
            height: 2em;
        }
        .btn.btn-icon i {
            margin-right: 0;
        }
        @media all and (max-width: 767px) {
            .responsive-table .table-header {
                display: none;
            }
            .responsive-table li {
                display: block;
            }
            .responsive-table .col {
                flex-basis: 100%;
            }
            .responsive-table .col {
                display: flex;
                padding: 10px 0;
            }
            .responsive-table .col:before {
                color: #6c7a89;
                padding-right: 10px;
                content: attr(data-label);
                flex-basis: 50%;
                text-align: right;
            }
        }
    </style>
{% endblock %}
{% block title %} {{ communaute.titre }} {% endblock %}
{% block meta %}{{ communaute.descCourt }}{% endblock %}
{% block body %}
<div class="main">
    <div class="header-comm-sm">
        <div class="community-form-container-sm">
            <div class="container-menu">
                {% block container_sm %}{{ parent() }}{% endblock %}
            </div>
        </div>
        <h3 class="text-comm">rassemblez votre tribu</h3>
    </div>
    {% block loginSm %}{{ parent() }}{% endblock %}
    <div class="community-form-container">
        <div class="sub-container"></div>
        <div class="container-menu">
            {% block container %}{{ parent() }}{% endblock %}
        </div>
    </div>
    <div class="community-container">
        <div class="community-header">
            <div class="community-background d-flex justify-content-center align-items-center">
                <div class="water loader-md"></div>
                <img class="d-none" src="{{ communaute.photoCouverture is null ? asset('assets/image/empty-image-min.jpg') : asset('couverture/' ~ communaute.photoCouverture) }}" alt="pdc communaute">
            </div>
            <div class="community-title">
                <div class="community-profil d-flex justify-content-center align-items-center">
                    <div class="water loader-md"></div>
                    <img src="{{ communaute.photoProfil is null ? asset('assets/image/empty-image-min.jpg') : asset('profil/' ~ communaute.photoProfil) }}" alt="pdp  communaute" class="d-none">
                </div>
                {% if app.user %}
                    {% if app.user and app.user.id == communaute.user.id or app.user and membre is not null and membre.role is not null and membre.role.libelle == 'administrateur' %}
                        <a class="text-decoration-none" style="position: relative;left: 145px;top: -59px;" href="{{ path('editMyCommunaute', {urlPublic: communaute.urlPublic}) }}"><i class="fa fa-pen"></i></a>
                    {% endif %}
                {% endif %}
                <div class="community-description">
                    <h1 id="title">{{ communaute.titre }}</h1>
                    <h2 class="sous-titre" id="subtitle">{{ communaute.sousTitre }}</h2>
                    <a target="_blank" rel="noreferrer noopener" href="{{ communaute.siteWeb }}" class="site-web" id="website">{{ communaute.siteWeb }}</a>
                    <p id="short-description">{{ communaute.descCourt }}</p>
                </div>
            </div>
        </div>
        {% include 'user/navbar.html.twig' %}
        <hr class="separator">
        <div class="row mb-5 p-4">
            <a href="#" onclick="addCateg(event)" class="ml-auto mr-5 my-3 btn btn-success">ajouter</a>
            <ul class="col-12 responsive-table">
                <li class="table-header">
                    <div class="col col-4">NOM</div>
                    <div class="col col-4">NOMBRE D'ARTICLES</div>
                    <div class="col col-4">ACTIONS</div>
                </li>
                {% for category in categories %}
                    <li class="table-row" data-id="{{ category.id }}">
                        <div class="col col-4" data-label="Nom"><span>{{ category.nom }}</span></div>
                        <div class="col col-4" data-label="Nombre d'articles">{{ category.articles|length }}</div>
                        <div class="col col-4" data-label="Actions">
                            <a onclick="updateCateg(event)" href="#" class="btn btn-icon btn-light btn-hover-primary btn-sm mr-2{{ category.nom|lower == 'général' ? ' disabled' : '' }}">
                        <span class="svg-icon svg-icon-md svg-icon-primary">
                            <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="20px" height="20px" viewBox="0 0 24 24" version="1.1">
                                <g stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
                                    <rect x="0" y="0" width="24" height="24"></rect>
                                    <path d="M12.2674799,18.2323597 L12.0084872,5.45852451 C12.0004303,5.06114792 12.1504154,4.6768183 12.4255037,4.38993949 L15.0030167,1.70195304 L17.5910752,4.40093695 C17.8599071,4.6812911 18.0095067,5.05499603 18.0083938,5.44341307 L17.9718262,18.2062508 C17.9694575,19.0329966 17.2985816,19.701953 16.4718324,19.701953 L13.7671717,19.701953 C12.9505952,19.701953 12.2840328,19.0487684 12.2674799,18.2323597 Z" fill="#000000" fill-rule="nonzero" transform="translate(14.701953, 10.701953) rotate(-135.000000) translate(-14.701953, -10.701953)"></path>
                                    <path d="M12.9,2 C13.4522847,2 13.9,2.44771525 13.9,3 C13.9,3.55228475 13.4522847,4 12.9,4 L6,4 C4.8954305,4 4,4.8954305 4,6 L4,18 C4,19.1045695 4.8954305,20 6,20 L18,20 C19.1045695,20 20,19.1045695 20,18 L20,13 C20,12.4477153 20.4477153,12 21,12 C21.5522847,12 22,12.4477153 22,13 L22,18 C22,20.209139 20.209139,22 18,22 L6,22 C3.790861,22 2,20.209139 2,18 L2,6 C2,3.790861 3.790861,2 6,2 L12.9,2 Z" fill="#000000" fill-rule="nonzero" opacity="0.3"></path>
                                </g>
                            </svg>
                        </span>
                            </a>
                            <a onclick="removeCateg(event)" href="#" class="btn btn-icon btn-light btn-hover-primary btn-sm{{ category.nom|lower == 'général' ? ' disabled' : '' }}">
                        <span class="svg-icon svg-icon-md svg-icon-primary">
                            <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="20px" height="20px" viewBox="0 0 24 24" version="1.1">
                                <g stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
                                    <rect x="0" y="0" width="24" height="24"></rect>
                                    <path d="M6,8 L6,20.5 C6,21.3284271 6.67157288,22 7.5,22 L16.5,22 C17.3284271,22 18,21.3284271 18,20.5 L18,8 L6,8 Z" fill="#000000" fill-rule="nonzero"></path>
                                    <path d="M14,4.5 L14,4 C14,3.44771525 13.5522847,3 13,3 L11,3 C10.4477153,3 10,3.44771525 10,4 L10,4.5 L5.5,4.5 C5.22385763,4.5 5,4.72385763 5,5 L5,5.5 C5,5.77614237 5.22385763,6 5.5,6 L18.5,6 C18.7761424,6 19,5.77614237 19,5.5 L19,5 C19,4.72385763 18.7761424,4.5 18.5,4.5 L14,4.5 Z" fill="#000000" opacity="0.3"></path>
                                </g>
                            </svg>
                        </span>
                            </a>
                        </div>
                    </li>
                    {% else %}
                    <li class="table-row">
                        <h3 class="mx-auto empty">Il n'y a pas de catégorie</h3>
                    </li>
                {% endfor %}
            </ul>
            <a href="{{ path('userShowArticles', {urlPublic: communaute.urlPublic}) }}" class="btn btn-sm btn-yellow ml-auto mr-5">Revenir</a>
        </div>
    </div>
</div>
{% endblock %}
{% block javascripts %}
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/js/toastr.min.js" integrity="sha512-VEd+nq25CkR676O+pLBnDW09R7VQX9Mdiij052gVCp5yVH3jGtH70Ho/UUv4mJDsEdTvqRCFZg0NKGiojGnUCw==" crossorigin="anonymous"></script>
    <script>
        const fetchAction = async function (url, data = {}) {
            const response = await fetch(url, {
                credentials: 'same-origin',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    "content-type": "application/json"
                },
                method: 'POST',
                body: JSON.stringify(data)
            });
            if (response.ok) {
                return response.json()
            } else {
                let error = await response.json()
                throw new Error(error.message)
            }
        }
        const cancelCateg = function (e) {
            e.preventDefault()
            $(e.target).closest('li').fadeOut('fast', function () {
                this.remove()
                if (document.querySelectorAll('.table-row').length === 0) {
                    const li = document.createElement('li')
                    li.className = 'table-row'
                    li.innerHTML = `<h3 class="mx-auto empty">Il n'y a pas de catégorie</h3>`
                    $(".responsive-table .table-header").after(li)
                }
            })
        }
        const cancelModif = function (e, value) {
            e.preventDefault()
            const content = $(e.target).closest('li').find('div[data-label="Nom"]')
            const actions = `<a onclick="updateCateg(event)" href="#" class="btn btn-icon btn-light btn-hover-primary btn-sm mr-2">
                        <span class="svg-icon svg-icon-md svg-icon-primary">
                            <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="20px" height="20px" viewBox="0 0 24 24" version="1.1">
                                <g stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
                                    <rect x="0" y="0" width="24" height="24"></rect>
                                    <path d="M12.2674799,18.2323597 L12.0084872,5.45852451 C12.0004303,5.06114792 12.1504154,4.6768183 12.4255037,4.38993949 L15.0030167,1.70195304 L17.5910752,4.40093695 C17.8599071,4.6812911 18.0095067,5.05499603 18.0083938,5.44341307 L17.9718262,18.2062508 C17.9694575,19.0329966 17.2985816,19.701953 16.4718324,19.701953 L13.7671717,19.701953 C12.9505952,19.701953 12.2840328,19.0487684 12.2674799,18.2323597 Z" fill="#000000" fill-rule="nonzero" transform="translate(14.701953, 10.701953) rotate(-135.000000) translate(-14.701953, -10.701953)"></path>
                                    <path d="M12.9,2 C13.4522847,2 13.9,2.44771525 13.9,3 C13.9,3.55228475 13.4522847,4 12.9,4 L6,4 C4.8954305,4 4,4.8954305 4,6 L4,18 C4,19.1045695 4.8954305,20 6,20 L18,20 C19.1045695,20 20,19.1045695 20,18 L20,13 C20,12.4477153 20.4477153,12 21,12 C21.5522847,12 22,12.4477153 22,13 L22,18 C22,20.209139 20.209139,22 18,22 L6,22 C3.790861,22 2,20.209139 2,18 L2,6 C2,3.790861 3.790861,2 6,2 L12.9,2 Z" fill="#000000" fill-rule="nonzero" opacity="0.3"></path>
                                </g>
                            </svg>
                        </span>
                            </a>
                            <a onclick="removeCateg(event)" href="#" class="btn btn-icon btn-light btn-hover-primary btn-sm">
                        <span class="svg-icon svg-icon-md svg-icon-primary">
                            <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="20px" height="20px" viewBox="0 0 24 24" version="1.1">
                                <g stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
                                    <rect x="0" y="0" width="24" height="24"></rect>
                                    <path d="M6,8 L6,20.5 C6,21.3284271 6.67157288,22 7.5,22 L16.5,22 C17.3284271,22 18,21.3284271 18,20.5 L18,8 L6,8 Z" fill="#000000" fill-rule="nonzero"></path>
                                    <path d="M14,4.5 L14,4 C14,3.44771525 13.5522847,3 13,3 L11,3 C10.4477153,3 10,3.44771525 10,4 L10,4.5 L5.5,4.5 C5.22385763,4.5 5,4.72385763 5,5 L5,5.5 C5,5.77614237 5.22385763,6 5.5,6 L18.5,6 C18.7761424,6 19,5.77614237 19,5.5 L19,5 C19,4.72385763 18.7761424,4.5 18.5,4.5 L14,4.5 Z" fill="#000000" opacity="0.3"></path>
                                </g>
                            </svg>
                        </span>
                            </a>`
            const span = document.createElement('span')
            span.textContent = value
            content.html(span)
            $(e.target).closest('div[data-label="Actions"]').html(actions)
        }
        const removeCateg = async function (e) {
            e.preventDefault()
            if (!confirm('Voulez-vous vraiment supprimer cette catégorie ?')) return
            const id = $(e.target).closest('li').data('id')
            const response = await fetchAction("/in/remove-category-".concat(id, ".html"))
            if (response.result === 'success') {
                $(e.target).closest('li').fadeOut('slow', function () {
                    this.remove()
                })
            } else if (response.result === 'denied') {
                const opts = {
                    "closeButton": true,
                    "debug": false,
                    "newestOnTop": false,
                    "progressBar": true,
                    "positionClass": "toast-top-right",
                    "preventDuplicates": true,
                    "onclick": null,
                    "showDuration": "300",
                    "hideDuration": "1000",
                    "timeOut": "10000",
                    "extendedTimeOut": "1000",
                    "showEasing": "swing",
                    "hideEasing": "linear",
                    "showMethod": "fadeIn",
                    "hideMethod": "fadeOut"
                };
                toastr.error("Cette catégorie ne peut pas être supprimée.", '', opts);
            } else {
                const opts = {
                    "closeButton": true,
                    "debug": false,
                    "newestOnTop": false,
                    "progressBar": true,
                    "positionClass": "toast-top-right",
                    "preventDuplicates": true,
                    "onclick": null,
                    "showDuration": "300",
                    "hideDuration": "1000",
                    "timeOut": "10000",
                    "extendedTimeOut": "1000",
                    "showEasing": "swing",
                    "hideEasing": "linear",
                    "showMethod": "fadeIn",
                    "hideMethod": "fadeOut"
                };
                toastr.error("Une erreur a été rencontrée.", '', opts);
            }
        }

        const updateCateg = async function (e) {
            e.preventDefault()
            const target = $(e.target).closest('li').find('div[data-label="Nom"]')
            let value = target.find('span').text()
            const id = $(e.target).closest('li').data('id')
            const input = `<input type="text" class="form-control" value="${value}" placeholder="nom de la catégorie">`
            const error = `<div class="invalid-feedback">
                                Une catégorie du même nom existe déjà.
                            </div>`
            const actions = `<a onclick="submitCateg(event, true, ${id})" href="#" class="btn btn-icon btn-light btn-hover-primary btn-sm mr-2">
                                <i class="fas fa-check"></i>
                            </a>
                            <a onclick="cancelModif(event, '${value}')" title=annuler href="#" class="btn btn-icon btn-outline-danger btn-hover-primary btn-sm">
                                <i class="fas fa-times"></i>
                            </a>`
            target.html(input).append(error)
            $(e.target).closest('div[data-label="Actions"]').html(actions)
            target.find('input').focus()
        }
        const submitCateg = async function (e, edit = false, id = null) {
            e.preventDefault()
            const loading = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>'
            if (e.target.tagName === 'A') {
                e.target.querySelector('i').style.display = 'none'
                $(e.target).append(loading)
            } else {
                e.target.style.display = 'none'
                $(e.target).after(loading)
            }
            let category = $(e.target).closest('li').find('input').val()
            const response = await fetchAction("{{ path('addCategory', {id: communaute.id}) }}", {'category': category, 'edit': edit, 'id': id})
            if (e.target.tagName === 'A') {
                e.target.querySelector('i').style.display = null
                e.target.querySelector('.spinner-border.spinner-border-sm').remove()
            } else {
                e.target.style.display = null
                e.target.parentElement.querySelector('.spinner-border.spinner-border-sm').remove()
            }
            if (response.result === 'success')
            {
                const li = document.createElement('li')
                li.className = 'table-row';
                li.setAttribute('data-id', response.data.id)
                li.innerHTML = `<div class="col col-4" data-label="Nom">
                                    <span>${category}</span>
                                </div>
                                <div class="col col-4" data-label="Nombre d'articles">${response.data.articles}</div>
                                <div class="col col-4" data-label="Actions">
                                    <a onclick="updateCateg(event)" href="#" class="btn btn-icon btn-light btn-hover-primary btn-sm mr-2">
                                <span class="svg-icon svg-icon-md svg-icon-primary">
                                    <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="20px" height="20px" viewBox="0 0 24 24" version="1.1">
                                        <g stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
                                            <rect x="0" y="0" width="24" height="24"></rect>
                                            <path d="M12.2674799,18.2323597 L12.0084872,5.45852451 C12.0004303,5.06114792 12.1504154,4.6768183 12.4255037,4.38993949 L15.0030167,1.70195304 L17.5910752,4.40093695 C17.8599071,4.6812911 18.0095067,5.05499603 18.0083938,5.44341307 L17.9718262,18.2062508 C17.9694575,19.0329966 17.2985816,19.701953 16.4718324,19.701953 L13.7671717,19.701953 C12.9505952,19.701953 12.2840328,19.0487684 12.2674799,18.2323597 Z" fill="#000000" fill-rule="nonzero" transform="translate(14.701953, 10.701953) rotate(-135.000000) translate(-14.701953, -10.701953)"></path>
                                            <path d="M12.9,2 C13.4522847,2 13.9,2.44771525 13.9,3 C13.9,3.55228475 13.4522847,4 12.9,4 L6,4 C4.8954305,4 4,4.8954305 4,6 L4,18 C4,19.1045695 4.8954305,20 6,20 L18,20 C19.1045695,20 20,19.1045695 20,18 L20,13 C20,12.4477153 20.4477153,12 21,12 C21.5522847,12 22,12.4477153 22,13 L22,18 C22,20.209139 20.209139,22 18,22 L6,22 C3.790861,22 2,20.209139 2,18 L2,6 C2,3.790861 3.790861,2 6,2 L12.9,2 Z" fill="#000000" fill-rule="nonzero" opacity="0.3"></path>
                                        </g>
                                    </svg>
                                </span>
                                    </a>
                                    <a onclick="removeCateg(event)" href="#" class="btn btn-icon btn-light btn-hover-primary btn-sm">
                                <span class="svg-icon svg-icon-md svg-icon-primary">
                                    <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="20px" height="20px" viewBox="0 0 24 24" version="1.1">
                                        <g stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
                                            <rect x="0" y="0" width="24" height="24"></rect>
                                            <path d="M6,8 L6,20.5 C6,21.3284271 6.67157288,22 7.5,22 L16.5,22 C17.3284271,22 18,21.3284271 18,20.5 L18,8 L6,8 Z" fill="#000000" fill-rule="nonzero"></path>
                                            <path d="M14,4.5 L14,4 C14,3.44771525 13.5522847,3 13,3 L11,3 C10.4477153,3 10,3.44771525 10,4 L10,4.5 L5.5,4.5 C5.22385763,4.5 5,4.72385763 5,5 L5,5.5 C5,5.77614237 5.22385763,6 5.5,6 L18.5,6 C18.7761424,6 19,5.77614237 19,5.5 L19,5 C19,4.72385763 18.7761424,4.5 18.5,4.5 L14,4.5 Z" fill="#000000" opacity="0.3"></path>
                                        </g>
                                    </svg>
                                </span>
                                    </a>
                                </div>`
                $(e.target).closest('li').replaceWith(li)
            }
            else if (response.result === 'exist') {
                $(e.target).closest('li').find('input').addClass('is-invalid')
                $(e.target).closest('li').find('div.invalid-feedback').text('Une catégorie du même nom existe déjà.')
            }
            else if (response.result === 'denied') {
                $(e.target).closest('li').find('input').addClass('is-invalid')
                $(e.target).closest('li').find('div.invalid-feedback').text('Cette catégorie ne peut pas être modifiée.')
            } else {
                $(e.target).closest('li').find('input').addClass('is-invalid')
                $(e.target).closest('li').find('div.invalid-feedback').text('Une erreur a été rencontrée.')
            }
        }
        const addCateg = function (e) {
            e.preventDefault()
            const li = document.createElement('li')
            li.className = 'table-row';
            li.innerHTML = `<div class="col col-4" data-label="Nom">
                            <input type="text" class="form-control" placeholder="nom de la catégorie">
                            <div class="invalid-feedback">
                                Une catégorie du même nom existe déjà.
                            </div>
                        </div>
                        <div class="col col-4" data-label="Nombre d'articles">0</div>
                        <div class="col col-4" data-label="Actions">
                            <a onclick="submitCateg(event)" href="#" class="btn btn-icon btn-light btn-hover-primary btn-sm mr-2">
                                <i class="fas fa-check"></i>
                            </a>
                            <a onclick="cancelCateg(event)" title=annuler href="#" class="btn btn-icon btn-outline-danger btn-hover-primary btn-sm">
                                <i class="fas fa-times"></i>
                            </a>
                        </div>`
            if (document.querySelectorAll('.empty').length !== 0)
                $(document.querySelector('.empty')).closest('li').fadeOut('fast', function () {
                    this.remove()
                })
            $(".responsive-table .table-header").after(li)
            $(li).find('input').focus()
        }
    </script>
{% endblock %}

