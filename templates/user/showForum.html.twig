{% extends 'layout2.html.twig' %}

{% block stylesheets %}

    <link href="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/summernote.min.css" rel="stylesheet">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/css/toastr.min.css" integrity="sha512-vKMx8UnXk60zUwyUnUPM3HbQo8QfmNx7+ltw8Pm5zLusl1XIfwcxo8DbWCqMGKaWeNxWA8yrx5v3SaVpMvR3CA==" crossorigin="anonymous" />

     <style>

        p.text-secondary p{
            width: 610px;
        }

        p img{

           width: 100% !important;
        }



    </style>

{% endblock %}

{% block title %}Forum de discussion de votre communauté{% endblock %}
{% block metaTitle %}forum de discussion de votre communauté{% endblock %}
{% block meta %}Echangeons nos idées , notre savoir,  apportons nos conseils , nos avis dans le forum de TribADD et recevez les réponses dans les plus brefs délais{% endblock %}

{% block body %}

    <div class="main">

        <div class="header-comm-sm">

            <div class="community-form-container-sm">

                <div class="container-menu">

                    {% block container_sm %}{{ parent() }}{% endblock %}

                </div>

            </div>

            <h3 class="text-comm">rassemblez votre tribu</h3>

        </div>

        {% block loginSm %}{{ parent() }}{% endblock %}

        <div class="community-form-container">

            <div class="sub-container"></div>

            <div class="container-menu">

                {% block container %}{{ parent() }}{% endblock %}

            </div>

        </div>

        <div class="community-container">

            <div class="community-header">

                <div class="community-background d-flex justify-content-center align-items-center">

                    <div class="water loader-md"></div>

                    <img class="d-none" src="{{ communaute.photoCouverture is null ? asset('assets/image/empty-image-min.jpg') : asset('couverture/' ~ communaute.photoCouverture) }}" alt="couverture de communaute">

                </div>

                <div class="community-title">

                    <div class="community-profil d-flex justify-content-center align-items-center">

                        <div class="water loader-md"></div>

                        <img src="{{ communaute.photoProfil is null ? asset('assets/image/empty-image-min.jpg') : asset('profil/' ~ communaute.photoProfil) }}" alt="profil de communaute" class="d-none">

                    </div>
                    {% if app.user %}
                        {% if app.user and app.user.id == communaute.user.id or app.user and membre is not null and membre.role is not null and membre.role.libelle == 'administrateur' %}
                            <a class="text-decoration-none" style="position: relative;left: 145px;top: -59px;" href="{{ path('editMyCommunaute', {urlPublic: communaute.urlPublic}) }}"><i class="fa fa-pen"></i></a>
                         {% endif %}
                     {% endif %}

                    <div class="community-description">

                        <h1 id="title">{{ communaute.titre }}</h1>

                        <h2 class="sous-titre" id="subtitle">{{ communaute.sousTitre }}</h2>

                        <a target="_blank" rel="noreferrer noopener" href="{{ communaute.siteWeb }}" class="site-web" id="website">{{ communaute.siteWeb }}</a>

                        <p id="short-description">{{ communaute.descCourt }}</p>

                    </div>

                </div>

            </div>

            {% include 'user/navbar.html.twig' %}

           <hr class="separator">

            <div class="community-body">

                <div class="forum-titre">

                    <div class="card mb-2">

                        <div class="card-body p-2 p-sm-3">

                            <div class="media forum-item">

                                <img src="{{ forums.user.photo is null ? asset('assets/image/user.png') : asset('photo_de_profil/' ~ forums.user.photo) }}" class="mr-3 rounded-circle"  width="50" height="50" alt="User" />

                                <div class="media-body" style="width: 610px;padding-right: 30px;">

                                    <h3><a href="#" data-toggle="collapse" data-target=".forum-content" class="text-body">{{ forums.titre }}></a></h3>

                                    <p class="text-muted"><b>{{ forums.user.username }} </b><i>  il y a <span class="text-secondary font-weight-bold"><time>{{ forums.createAt|date('d/m/Y à H:i') }}</time></span></i></p>

                                    <p class="text-secondary" style="width: 610px;font-size: 15px;"> {{ forums.contenu|raw }}  </p>

                                       

                                  

                                </div>

                            </div>

                        </div>

                    </div>

                      {% if count is null %}

                         <h3> 0 Réponse </h3>

                        {% elseif count == 1 %}

                        <h3> 1 Réponse </h3>

                       {% elseif count >= 1%}

                       <h3> {{ count  }} réponses </h3>

                       {% endif %}

                     <hr class="separator">

                    {% for fr in frs|reverse %}

                          <div class="forum-reponse" data-id="{{ fr.id }}">

                            <div class="card"  style="margin-left: 40px;margin-bottom: 10px;background-color:#f5f5f5;">

                                    <div class="card-body p-2 p-sm-3">

                                           <p class="text-muted" style="margin-left: 66px;"><b>{{ fr.user.username }} </b><i>  il y a <span class="text-secondary font-weight-bold"><time>{{ fr.createAt|date('d/m/Y à H:i') }}</time></span></i></p>

                                        

                                              <div class="text-muted small text-center align-self-center" style="margin-right: 15px;position: absolute;top: 5px;right: 0">

                                                {% if app.user and communaute.user == app.user or app.user and membre is defined and membre is not null and membre.role is not null and membre.role.droitsUtilisateur.suppression == 1 %}

                                                    <a onclick="removeForumReponse(event, {{ fr.id }}, '{{ csrf_token('remove'~fr.id) }}')" class="btn btn-default" href="#"><i class="fa fa-trash-alt"></i></a>

                                                {% endif %}

                                            </div>

                                       

                                        <div class="media forum-item">

                                            <img src="{{ fr.user.photo is null ? asset('assets/image/user.png') : asset('photo_de_profil/' ~ fr.user.photo) }}" class="mr-3 rounded-circle"  width="50" height="50" alt="User" />

                                            <div class="media-body" style="width: 610px;padding-right: 30px;">

                                                <p class="text-secondary" style="width: 610px;font-size: 15px;">{{ fr.contenu|raw }} </p>

                                            </div>

                                        </div>

                                        

                                    </div>

                                </div>

                             </div>   

                             {% else %}

                            <div class="col-md-12">

                                <h3>Il n'y a pas de reponse</h3>

                            </div>

                    {% endfor %}

                    {% if app.user == communaute.user or membre is defined and membre is not null and membre.role is not null %}

                        <div class="card my-4" style="margin-left: 40px;">

                            <h5 class="card-header">Laisser un commentaire:</h5>

                            <div class="card-body" style="width: 100%;">

                                {{ form_start(form) }}

                                <div class="form-group">

                                    {{ form_widget(form.contenu, {'attr': {'class': 'contenu summernote'}}) }}

                                    {{ form_errors(form.contenu) }}

                                </div>

                                <div class="form-group">

                                    <input type="hidden"  value="{{forums.id}}">

                                    <input type="submit" class="btn btn-sm btn-yellow" value="REPONDRE">

                                    <a href="{{ path('forum', {urlPublic: communaute.urlPublic}) }}" class="btn btn-sm btn-yellow">ANNULER</a>

                                </div>

                                {{ form_end(form) }}

                            </div>

                        </div>

                    {% endif %}
                      {% if app.user is null %}
                       <div class="container" style="margin-left: 24px;">
                            <a href="{{ path('forum', {urlPublic: communaute.urlPublic}) }}" class="btn btn-sm btn-yellow">ANNULER</a>
                       </div>
                          
                      {% endif %}
                </div>

            </div>

        </div>

    </div>

{% endblock %}

{% block javascripts %}

    <script src="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/summernote.min.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js" integrity="sha512-qTXRIMyZIFb8iQcfjXWCO8+M5Tbc38Qi5WzdPOYZHIlZpzBHG3L3by84BBBOiRGiEb7KKtAOAs5qYdUiZiQNNQ==" crossorigin="anonymous"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/locale/fr.min.js" integrity="sha512-RAt2+PIRwJiyjWpzvvhKAG2LEdPpQhTgWfbEkFDCo8wC4rFYh5GQzJBVIFDswwaEDEYX16GEE/4fpeDNr7OIZw==" crossorigin="anonymous"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/js/toastr.min.js" integrity="sha512-VEd+nq25CkR676O+pLBnDW09R7VQX9Mdiij052gVCp5yVH3jGtH70Ho/UUv4mJDsEdTvqRCFZg0NKGiojGnUCw==" crossorigin="anonymous"></script>

   <script type="text/javascript">

        $(document).ready(function() {

            $('.contenu').summernote({

                tabsize: 2,

                height:200,

                placeholder: 'Contenu'

            });

           

        });



         const fetchAction = async function (url, data = {}) {

            const response = await fetch(url, {

                credentials: 'same-origin',

                headers: {

                    'X-Requested-With': 'XMLHttpRequest',

                    "content-type": "application/json"

                },

                method: 'POST',

                body: JSON.stringify(data)

            });

            if (response.ok) {

                return response.json()

            } else {

                let error = await response.json()

                throw new Error(error.message)

            }

        }

        const removeForumReponse = async function (e, id, token) {

            e.preventDefault()

            if (!confirm('Voulez-vous vraiment supprimer la reponse ?')) return

            const response = await fetchAction("/in/remove/forum-repondre-".concat(id), {'_token': token})

            if (response.result === 'success') {

               const opts = {

                    "closeButton": true,

                    "debug": false,

                    "newestOnTop": false,

                    "progressBar": true,

                    "positionClass": "toast-top-right",

                    "preventDuplicates": true,

                    "onclick": null,

                    "showDuration": "300",

                    "hideDuration": "1000",

                    "timeOut": "10000",

                    "extendedTimeOut": "1000",

                    "showEasing": "swing",

                    "hideEasing": "linear",

                    "showMethod": "fadeIn",

                    "hideMethod": "fadeOut"

                };

                toastr.success("La reponse a été supprimé! Vous allez quitter la page", '', opts);

                $(e.target).closest('.forum-reponse').fadeOut('slow', function () {

                    this.remove()

                });



            } else {

                const opts = {

                    "closeButton": true,

                    "debug": false,

                    "newestOnTop": false,

                    "progressBar": true,

                    "positionClass": "toast-top-right",

                    "preventDuplicates": true,

                    "onclick": null,

                    "showDuration": "300",

                    "hideDuration": "1000",

                    "timeOut": "10000",

                    "extendedTimeOut": "1000",

                    "showEasing": "swing",

                    "hideEasing": "linear",

                    "showMethod": "fadeIn",

                    "hideMethod": "fadeOut"

                };

                toastr.error("Echec de la suppression de reponse", '', opts);

            }

        }



    </script>

{% endblock %}